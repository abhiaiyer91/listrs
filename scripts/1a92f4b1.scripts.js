"use strict";function product(a,b,c,d,e){this.sku=a,this.name=b,this.description=c,this.price=d,this.cal=e}function store(){this.products=[new product("BRNZ","Bronze Membership","Eat one every day to keep the doctor away!",60,90,0,2,0,1,2),new product("SLVR","Silver Membership","Guacamole anyone?",80,90,0,1,1,1,2),new product("GOLC","Gold Membership","These are rich in Potassium and easy to peel.",100,120,0,2,1,2,2)],this.dvaCaption=["Negligible","Low","Average","Good","Great"],this.dvaRange=["below 5%","between 5 and 10%","between 10 and 20%","between 20 and 40%","above 40%"]}function shoppingCart(a){this.cartName=a,this.clearCart=!1,this.checkoutParameters={},this.items=[],this.loadItems();var b=this;$(window).unload(function(){b.clearCart&&b.clearItems(),b.saveItems(),b.clearCart=!1})}function checkoutParameters(a,b,c){this.serviceName=a,this.merchantID=b,this.options=c}function cartItem(a,b,c,d){this.sku=a,this.name=b,this.price=1*c,this.quantity=1*d}var app=angular.module("listrApp",["ngCookies","ngResource","ngSanitize","ui.router","ngRoute","google-maps","firebase"]);app.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/home"),a.state("home",{url:"/home",templateUrl:"views/main.html",controller:"MainCtrl"}).state("register",{url:"/signup",templateUrl:"views/signup.html",controller:"AuthCtrl"}).state("login",{url:"/login",templateUrl:"views/login.html",controller:"AuthCtrl"}).state("membership",{url:"/membership",templateUrl:"views/membership.html",controller:"DataCtrl"}).state("buynow",{url:"/buynow",templateUrl:"views/store.html",controller:"StoreCtrl"}).state("products",{url:"/products/:productSku",templateUrl:"views/product.html",controller:"StoreCtrl"}).state("cart",{url:"/cart",templateUrl:"views/shoppingCart.html",controller:"StoreCtrl"})}]),app.constant("FIREBASE_URL","https://listr-fire.firebaseio.com/"),store.prototype.getProduct=function(a){for(var b=0;b<this.products.length;b++)if(this.products[b].sku==a)return this.products[b];return null},shoppingCart.prototype.loadItems=function(){var a=null!=localStorage?localStorage[this.cartName+"_items"]:null;if(null!=a&&null!=JSON)try{for(var a=JSON.parse(a),b=0;b<a.length;b++){var c=a[b];null!=c.sku&&null!=c.name&&null!=c.price&&null!=c.quantity&&(c=new cartItem(c.sku,c.name,c.price,c.quantity),this.items.push(c))}}catch(d){}},shoppingCart.prototype.saveItems=function(){null!=localStorage&&null!=JSON&&(localStorage[this.cartName+"_items"]=JSON.stringify(this.items))},shoppingCart.prototype.addItem=function(a,b,c,d){if(d=this.toNumber(d),0!=d){for(var e=!1,f=0;f<this.items.length&&!e;f++){var g=this.items[f];g.sku==a&&(e=!0,g.quantity=this.toNumber(g.quantity+d),g.quantity<=0&&this.items.splice(f,1))}if(!e){var g=new cartItem(a,b,c,d);this.items.push(g)}this.saveItems()}},shoppingCart.prototype.getTotalPrice=function(a){for(var b=0,c=0;c<this.items.length;c++){var d=this.items[c];(null==a||d.sku==a)&&(b+=this.toNumber(d.quantity*d.price))}return b},shoppingCart.prototype.getTotalCount=function(a){for(var b=0,c=0;c<this.items.length;c++){var d=this.items[c];(null==a||d.sku==a)&&(b+=this.toNumber(d.quantity))}return b},shoppingCart.prototype.clearItems=function(){this.items=[],this.saveItems()},shoppingCart.prototype.addCheckoutParameters=function(a,b,c){if("PayPal"!=a&&"Google"!=a&&"Stripe"!=a)throw"serviceName must be 'PayPal' or 'Google' or 'Stripe'.";if(null==b)throw"A merchantID is required in order to checkout.";this.checkoutParameters[a]=new checkoutParameters(a,b,c)},shoppingCart.prototype.checkout=function(a,b){if(null==a){var c=this.checkoutParameters[Object.keys(this.checkoutParameters)[0]];a=c.serviceName}if(null==a)throw"Use the 'addCheckoutParameters' method to define at least one checkout service.";var d=this.checkoutParameters[a];if(null==d)throw"Cannot get checkout parameters for '"+a+"'.";switch(d.serviceName){case"PayPal":this.checkoutPayPal(d,b);break;case"Google":this.checkoutGoogle(d,b);break;case"Stripe":this.checkoutStripe(d,b);break;default:throw"Unknown checkout service: "+d.serviceName}},shoppingCart.prototype.checkoutPayPal=function(a,b){for(var c={cmd:"_cart",business:a.merchantID,upload:"1",rm:"2",charset:"utf-8"},d=0;d<this.items.length;d++){var e=this.items[d],f=d+1;c["item_number_"+f]=e.sku,c["item_name_"+f]=e.name,c["quantity_"+f]=e.quantity,c["amount_"+f]=e.price.toFixed(2)}var g=$("<form/></form>");g.attr("action","https://www.paypal.com/cgi-bin/webscr"),g.attr("method","POST"),g.attr("style","display:none;"),this.addFormFields(g,c),this.addFormFields(g,a.options),$("body").append(g),this.clearCart=null==b||b,g.submit(),g.remove()},shoppingCart.prototype.checkoutGoogle=function(a,b){for(var c={},d=0;d<this.items.length;d++){var e=this.items[d],f=d+1;c["item_name_"+f]=e.sku,c["item_description_"+f]=e.name,c["item_price_"+f]=e.price.toFixed(2),c["item_quantity_"+f]=e.quantity,c["item_merchant_id_"+f]=a.merchantID}var g=$("<form/></form>");g.attr("action","https://sandbox.google.com/checkout/api/checkout/v2/checkoutForm/Merchant/"+a.merchantID),g.attr("method","POST"),g.attr("style","display:none;"),this.addFormFields(g,c),this.addFormFields(g,a.options),$("body").append(g),this.clearCart=null==b||b,g.submit(),g.remove()},shoppingCart.prototype.checkoutStripe=function(a,b){for(var c={},d=0;d<this.items.length;d++){var e=this.items[d],f=d+1;c["item_name_"+f]=e.sku,c["item_description_"+f]=e.name,c["item_price_"+f]=e.price.toFixed(2),c["item_quantity_"+f]=e.quantity}var g=$(".form-stripe");g.empty(),g.attr("action",a.options.chargeurl),g.attr("method","POST"),g.attr("style","display:none;"),this.addFormFields(g,c),this.addFormFields(g,a.options),$("body").append(g),g.ajaxForm({success:function(){$.unblockUI(),alert("Thanks for your order!")},error:function(a){$.unblockUI(),alert("Error submitting order: "+a.statusText)}});var h=function(a){var c=$("<input type=hidden name=stripeToken />").val(a.id);$.blockUI({message:"Processing order..."}),g.append(c).submit(),this.clearCart=null==b||b,g.submit()};StripeCheckout.open({key:a.merchantID,address:!1,amount:100*this.getTotalPrice(),currency:"usd",name:"Purchase",description:"Description",panelLabel:"Checkout",token:h})},shoppingCart.prototype.addFormFields=function(a,b){null!=b&&$.each(b,function(b,c){if(null!=c){var d=$("<input></input>").attr("type","hidden").attr("name",b).val(c);a.append(d)}})},shoppingCart.prototype.toNumber=function(a){return a=1*a,isNaN(a)?0:a},app.controller("MainCtrl",["$scope",function(a){a.map={center:{latitude:32.716238,longitude:-117.160128},zoom:14,settings:{scrollwheel:!1}},a.marks={coords:{latitude:32.716238,longitude:-117.160128}}}]),app.controller("SignUpForm",["$scope",function(a){a.infos=[],a.complete=[],a.form={first_name:"",last_name:"",birthdate:"",email:"",home_address:"",city:"",phone:"",gender:"",venue:""},a.submitForm=function(){Form.save(a.form,function(b){a.infos[b.name]=a.form,a.form={first_name:"",last_name:"",birthdate:"",email:"",home_address:"",city:"",phone:"",gender:"",venue:""}})},a.fulfillForm=function(){var b=a.infos.shift();a.complete.push(b)},a.removeForm=function(b){a.infos.splice(b,1)}}]),app.controller("AuthCtrl",["$scope","$location","Auth","User",function(a,b,c,d){c.signedIn()&&b.path("/"),a.$on("$firebaseSimpleLogin:login",function(){b.path("/")}),a.login=function(){c.login(a.user).then(function(){b.path("/")},function(b){a.error=b.toString()})},a.register=function(){c.register(a.user).then(function(c){d.create(c,a.user.username),b.path("/")},function(b){a.error=b.toString()})}}]),app.controller("StoreCtrl",["$scope","$routeParams","DataService",function(a,b,c){a.store=c.store,a.cart=c.cart,null!=b.productSku&&(a.product=a.store.getProduct(b.productSku))}]),app.factory("User",["$firebase","$rootScope","FIREBASE_URL","Auth",function(a,b,c){function d(a){b.currentUser=g.findByUsername(a)}var e=new Firebase(c+"users"),f=a(e),g={create:function(a,b){f[b]={md5_hash:a.md5_hash,username:b,$priority:a.uid},f.$save(b).then(function(){d(b)})},findByUsername:function(a){return a?f.$child(a):void 0},getCurrent:function(){return b.currentUser},signedIn:function(){return void 0!==b.currentUser}};return b.$on("$firebaseSimpleLogin:login",function(b,c){var f=a(e.startAt(c.uid).endAt(c.uid));f.$on("loaded",function(){d(f.$getIndex()[0])})}),b.$on("$firebaseSimpleLogin:logout",function(){delete b.currentUser}),g}]),app.factory("Auth",["$firebaseSimpleLogin","FIREBASE_URL","$rootScope",function(a,b,c){var d=new Firebase(b),e=a(d),f={register:function(a){return e.$createUser(a.email,a.password)},signedIn:function(){return null!==e.user},notsigned:function(){return null==e.user},login:function(a){return e.$login("password",a)},logout:function(){e.$logout()}};return c.logout=function(){f.logout()},c.signedIn=function(){return f.signedIn()},c.notsigned=function(){return f.notsigned()},f}]),app.factory("DataService",function(){var a=new store,b=new shoppingCart("AngularStore");return b.addCheckoutParameters("PayPal","paypaluser@youremail.com"),b.addCheckoutParameters("Stripe","pk_test_qvGXLElB2OEGavnGnqp1P5Ln",{chargeurl:"https://localhost:9000/processStripe.aspx"}),{store:a,cart:b}}),app.factory("Post",["$firebase","FIREBASE_URL",function(a,b){var c=new Firebase(b+"posts"),d=a(c),e={all:d,create:function(a){if(User.signedIn()){var b=User.getCurrent();return a.owner=b.username,d.$add(a).then(function(a){var c=a.name();return b.$child("posts").$child(c).$set(c),c})}},find:function(a){return d.$child(a)},"delete":function(a){if(User.signedIn()){var b=e.find(a);b.$on("loaded",function(){var c=User.findByUsername(b.owner);d.$remove(a).then(function(){c.$child("posts").$remove(a)})})}}};return e}]);